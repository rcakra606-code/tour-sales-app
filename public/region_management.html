<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Region Management | Travel Dashboard</title>
  <link rel="stylesheet" href="./css/style.css" />
  <script defer src="./js/ui.js"></script>
</head>

<body class="light-mode">
  <!-- ===================================================== -->
  <!-- 🧭 SIDEBAR -->
  <!-- ===================================================== -->
  <aside id="sidebar" class="sidebar expanded">
    <div class="sidebar-header">
      <h2>Travel Dashboard</h2>
      <button id="toggleSidebar">☰</button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="dashboard.html">🏠 Dashboard</a></li>
      <li><a href="report_sales.html">💹 Laporan Sales</a></li>
      <li><a href="report_tour.html">✈️ Laporan Tour</a></li>
      <li><a href="report_document.html">📑 Laporan Dokumen</a></li>
      <li><a href="executive-dashboard.html">📊 Executive Dashboard</a></li>
      <li><a href="user-management.html">👥 User Management</a></li>
      <li class="active"><a href="region_management.html">🌍 Region Management</a></li>
      <li><a href="profile.html">👤 Profil</a></li>
      <li><a href="login.html" id="logoutBtn">🚪 Logout</a></li>
    </ul>
    <div class="theme-toggle">
      <span>🌞</span>
      <label class="switch">
        <input type="checkbox" id="themeSwitch" />
        <span class="slider round"></span>
      </label>
      <span>🌙</span>
    </div>
  </aside>

  <!-- ===================================================== -->
  <!-- 🌍 MAIN CONTENT -->
  <!-- ===================================================== -->
  <main id="main-content">
    <header>
      <h1>🌍 Region Management</h1>
      <p>Kelola daftar region yang digunakan dalam laporan Tour & penjualan.</p>
    </header>

    <!-- 📋 FORM TAMBAH REGION -->
    <section class="form-section">
      <form id="regionForm">
        <div class="form-grid">
          <div>
            <label>Nama Region</label>
            <input type="text" id="regionName" placeholder="Masukkan nama region baru" required />
          </div>
        </div>

        <button type="submit" id="addBtn">➕ Tambah Region</button>
        <button type="button" id="resetBtn" class="secondary">🔄 Reset</button>
        <p id="formMsg" class="message"></p>
      </form>
    </section>

    <!-- 📄 TABEL REGION -->
    <section class="table-section">
      <h3>Daftar Region</h3>
      <table id="regionTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nama Region</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- ===================================================== -->
  <!-- 📜 SCRIPT -->
  <!-- ===================================================== -->
  <script>
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");
    if (!token || role !== "admin") {
      alert("Akses ditolak. Hanya admin yang dapat mengakses halaman ini.");
      window.location.href = "dashboard.html";
    }

    const headers = { "Authorization": "Bearer " + token, "Content-Type": "application/json" };
    const regionForm = document.getElementById("regionForm");
    const msg = document.getElementById("formMsg");
    const tableBody = document.querySelector("#regionTable tbody");

    async function loadRegions() {
      try {
        const res = await fetch("/api/regions", { headers });
        if (!res.ok) throw new Error("Gagal memuat data region.");
        const data = await res.json();

        tableBody.innerHTML = data
          .map(
            (r) => `
            <tr>
              <td>${r.id}</td>
              <td>${r.name}</td>
              <td>
                <button onclick="deleteRegion(${r.id})" class="danger">🗑️ Hapus</button>
              </td>
            </tr>`
          )
          .join("");
      } catch (err) {
        console.error("❌ Gagal memuat region:", err);
        msg.textContent = "Gagal memuat data region.";
        msg.style.color = "#e74c3c";
      }
    }

    async function addRegion(e) {
      e.preventDefault();
      msg.textContent = "";
      const name = document.getElementById("regionName").value.trim();
      if (!name) {
        msg.textContent = "Nama region wajib diisi.";
        msg.style.color = "#e67e22";
        return;
      }

      try {
        const res = await fetch("/api/regions", {
          method: "POST",
          headers,
          body: JSON.stringify({ name }),
        });
        const data = await res.json();

        if (!res.ok) throw new Error(data.message || "Gagal menambah region.");

        msg.textContent = "Region berhasil ditambahkan.";
        msg.style.color = "#28a745";
        regionForm.reset();
        loadRegions();
      } catch (err) {
        console.error("❌ Gagal tambah region:", err);
        msg.textContent = "Gagal menambah region.";
        msg.style.color = "#e74c3c";
      }
    }

    async function deleteRegion(id) {
      if (!confirm("Yakin ingin menghapus region ini?")) return;
      try {
        const res = await fetch(`/api/regions/${id}`, { method: "DELETE", headers });
        if (!res.ok) throw new Error("Gagal menghapus region.");
        loadRegions();
      } catch (err) {
        console.error("❌ Gagal hapus region:", err);
      }
    }

    document.getElementById("resetBtn").addEventListener("click", () => {
      regionForm.reset();
      msg.textContent = "";
    });

    regionForm.addEventListener("submit", addRegion);

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });

    loadRegions();
  </script>
</body>
</html>