<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laporan Dokumen | Travel Dashboard</title>
  <link rel="stylesheet" href="./css/style.css" />
  <script defer src="./js/ui.js"></script>
</head>
<body class="light-mode">
  <!-- ===================================================== -->
  <!-- 🧭 SIDEBAR -->
  <!-- ===================================================== -->
  <aside id="sidebar" class="sidebar expanded">
    <div class="sidebar-header">
      <h2>Travel Dashboard</h2>
      <button id="toggleSidebar">☰</button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="dashboard.html">🏠 Dashboard</a></li>
      <li><a href="report_sales.html">💹 Laporan Sales</a></li>
      <li><a href="report_tour.html">✈️ Laporan Tour</a></li>
      <li class="active"><a href="report_document.html">📑 Laporan Dokumen</a></li>
      <li><a href="user-management.html">👥 User Management</a></li>
      <li><a href="profile.html">👤 Profil</a></li>
      <li><a href="login.html" id="logoutBtn">🚪 Logout</a></li>
    </ul>
    <div class="theme-toggle">
      <span>🌞</span>
      <label class="switch">
        <input type="checkbox" id="themeSwitch" />
        <span class="slider round"></span>
      </label>
      <span>🌙</span>
    </div>
  </aside>

  <!-- ===================================================== -->
  <!-- 📊 MAIN CONTENT -->
  <!-- ===================================================== -->
  <main id="main-content">
    <header>
      <h1>📑 Laporan Dokumen</h1>
      <p>Data dokumen tamu, proses visa, dan pengiriman</p>
    </header>

    <!-- 🔍 FILTERS -->
    <section class="filters">
      <input type="text" id="guestFilter" placeholder="Cari nama tamu..." />
      <input type="text" id="staffFilter" placeholder="Nama staff..." />
      <input type="month" id="monthFilter" />
      <button id="filterBtn">Terapkan Filter</button>
      <div class="export-buttons">
        <button id="exportExcel">📘 Export Excel</button>
        <button id="exportCSV">📄 Export CSV</button>
      </div>
    </section>

    <!-- 📋 TABLE -->
    <section class="table-section">
      <table id="documentTable">
        <thead>
          <tr>
            <th>No</th>
            <th>Tanggal Terima</th>
            <th>Tanggal Kirim</th>
            <th>Nama Tamu</th>
            <th>Jenis Dokumen</th>
            <th>Proses</th>
            <th>Kode Booking</th>
            <th>Nomor Invoice</th>
            <th>Staff</th>
            <th>Tour Code</th>
          </tr>
        </thead>
        <tbody id="documentTableBody">
          <tr><td colspan="10" class="center">Memuat data...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <!-- ===================================================== -->
  <!-- 📜 SCRIPT -->
  <!-- ===================================================== -->
  <script>
    const token = localStorage.getItem("token");
    const headers = { "Authorization": `Bearer ${token}` };

    async function fetchDocumentData(guest = "", staff = "", month = "") {
      try {
        const response = await fetch("/api/report/document", { headers });
        const data = await response.json();

        let filtered = data;
        if (guest) {
          filtered = filtered.filter((r) =>
            r.guest_name?.toLowerCase().includes(guest.toLowerCase())
          );
        }
        if (staff) {
          filtered = filtered.filter((r) =>
            r.staff_name?.toLowerCase().includes(staff.toLowerCase())
          );
        }
        if (month) {
          const [year, mon] = month.split("-");
          filtered = filtered.filter((r) => {
            const date = new Date(r.received_date);
            return (
              date.getFullYear() === parseInt(year) &&
              date.getMonth() + 1 === parseInt(mon)
            );
          });
        }

        const tbody = document.getElementById("documentTableBody");
        tbody.innerHTML = "";

        if (filtered.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="10" class="center">Tidak ada data ditemukan.</td></tr>';
          return;
        }

        filtered.forEach((row, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${new Date(row.received_date).toLocaleDateString("id-ID")}</td>
            <td>${row.sent_date ? new Date(row.sent_date).toLocaleDateString("id-ID") : "-"}</td>
            <td>${row.guest_name || "-"}</td>
            <td>${row.document_type || "-"}</td>
            <td>${row.process_type || "-"}</td>
            <td>${row.booking_code || "-"}</td>
            <td>${row.invoice_number || "-"}</td>
            <td>${row.staff_name || "-"}</td>
            <td>${row.tour_code || "-"}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("❌ Error memuat data dokumen:", err);
      }
    }

    document.getElementById("filterBtn").addEventListener("click", () => {
      const guest = document.getElementById("guestFilter").value;
      const staff = document.getElementById("staffFilter").value;
      const month = document.getElementById("monthFilter").value;
      fetchDocumentData(guest, staff, month);
    });

    document.getElementById("exportExcel").addEventListener("click", () => {
      window.open("/api/report/document/export?format=xlsx", "_blank");
    });

    document.getElementById("exportCSV").addEventListener("click", () => {
      window.open("/api/report/document/export?format=csv", "_blank");
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });

    // Jalankan saat load awal
    fetchDocumentData();
  </script>
</body>
</html>