<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Management | Travel Dashboard</title>
  <link rel="stylesheet" href="./css/style.css" />
  <script defer src="./js/ui.js"></script>
</head>

<body class="light-mode">
  <!-- ===================================================== -->
  <!-- 🧭 SIDEBAR -->
  <!-- ===================================================== -->
  <aside id="sidebar" class="sidebar expanded">
    <div class="sidebar-header">
      <h2>Travel Dashboard</h2>
      <button id="toggleSidebar">☰</button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="dashboard.html">🏠 Dashboard</a></li>
      <li><a href="report_sales.html">💹 Laporan Sales</a></li>
      <li><a href="report_tour.html">✈️ Laporan Tour</a></li>
      <li><a href="report_document.html">📑 Laporan Dokumen</a></li>
      <li><a href="executive-dashboard.html">📊 Executive Dashboard</a></li>
      <li class="active"><a href="user-management.html">👥 User Management</a></li>
      <li><a href="region_management.html">🌍 Region Management</a></li>
      <li><a href="profile.html">👤 Profil</a></li>
      <li><a href="login.html" id="logoutBtn">🚪 Logout</a></li>
    </ul>
    <div class="theme-toggle">
      <span>🌞</span>
      <label class="switch">
        <input type="checkbox" id="themeSwitch" />
        <span class="slider round"></span>
      </label>
      <span>🌙</span>
    </div>
  </aside>

  <!-- ===================================================== -->
  <!-- 📋 MAIN CONTENT -->
  <!-- ===================================================== -->
  <main id="main-content">
    <header>
      <h1>👥 Manajemen User</h1>
      <p>Kelola akun pengguna dan hak akses sistem.</p>
    </header>

    <!-- 🔸 FORM TAMBAH/EDIT USER -->
    <section class="form-section">
      <h3 id="formTitle">Tambah User</h3>
      <form id="userForm">
        <div class="form-grid">
          <div>
            <label for="username">Username</label>
            <input type="text" id="username" required placeholder="Masukkan username" />
          </div>
          <div>
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Masukkan password" />
          </div>
          <div>
            <label for="staff_name">Nama Staff</label>
            <input type="text" id="staff_name" placeholder="Nama lengkap staff" />
          </div>
          <div>
            <label for="role">Role</label>
            <select id="role" required>
              <option value="staff">Staff</option>
              <option value="semiadmin">Semi Admin</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <div style="margin-top: 10px;">
          <button type="submit" id="saveBtn">💾 Simpan</button>
          <button type="button" id="resetBtn" class="secondary">🔄 Reset</button>
        </div>
        <p id="formMsg" class="message"></p>
      </form>
    </section>

    <!-- 🔸 DAFTAR USER -->
    <section class="table-section">
      <h3>Daftar User</h3>
      <table id="userTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Nama Staff</th>
            <th>Role</th>
            <th>Dibuat</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- ===================================================== -->
  <!-- ⚙️ SCRIPT -->
  <!-- ===================================================== -->
  <script>
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");
    if (!token || (role !== "admin" && role !== "semiadmin")) {
      alert("Akses ditolak! Halaman ini hanya untuk Admin / SemiAdmin.");
      window.location.href = "dashboard.html";
    }

    const headers = {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token,
    };

    const userForm = document.getElementById("userForm");
    const userTable = document.querySelector("#userTable tbody");
    const formMsg = document.getElementById("formMsg");
    const formTitle = document.getElementById("formTitle");
    const saveBtn = document.getElementById("saveBtn");
    const resetBtn = document.getElementById("resetBtn");

    let editId = null;

    // =====================================================
    // 🧭 LOAD USERS
    // =====================================================
    async function loadUsers() {
      try {
        const res = await fetch("/api/users", { headers });
        const data = await res.json();

        userTable.innerHTML = data.map(u => `
          <tr>
            <td>${u.id}</td>
            <td>${u.username}</td>
            <td>${u.staff_name || "-"}</td>
            <td>${u.role}</td>
            <td>${new Date(u.created_at).toLocaleString("id-ID")}</td>
            <td>
              <button onclick="editUser(${u.id}, '${u.username}', '${u.staff_name || ""}', '${u.role}')">✏️ Edit</button>
              ${role === "admin" ? `<button class="danger" onclick="deleteUser(${u.id})">🗑️ Hapus</button>` : ""}
            </td>
          </tr>
        `).join("");
      } catch (err) {
        console.error("❌ Gagal load user:", err);
        formMsg.textContent = "Gagal memuat data user.";
      }
    }

    // =====================================================
    // 💾 SAVE / UPDATE USER
    // =====================================================
    userForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = {
        username: document.getElementById("username").value.trim(),
        password: document.getElementById("password").value.trim(),
        staff_name: document.getElementById("staff_name").value.trim(),
        role: document.getElementById("role").value,
      };

      try {
        const method = editId ? "PUT" : "POST";
        const url = editId ? `/api/users/${editId}` : "/api/users";

        const res = await fetch(url, {
          method,
          headers,
          body: JSON.stringify(data),
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.message);

        formMsg.textContent = result.message;
        formMsg.style.color = "green";
        userForm.reset();
        editId = null;
        formTitle.textContent = "Tambah User";
        saveBtn.textContent = "💾 Simpan";
        loadUsers();
      } catch (err) {
        console.error("❌ Save user error:", err);
        formMsg.textContent = err.message || "Gagal menyimpan user.";
        formMsg.style.color = "red";
      }
    });

    // =====================================================
    // ✏️ EDIT USER
    // =====================================================
    window.editUser = function(id, username, staff_name, role) {
      editId = id;
      document.getElementById("username").value = username;
      document.getElementById("staff_name").value = staff_name;
      document.getElementById("role").value = role;
      formTitle.textContent = "Edit User";
      saveBtn.textContent = "💾 Update";
      formMsg.textContent = "";
    };

    // =====================================================
    // 🗑️ DELETE USER
    // =====================================================
    window.deleteUser = async function(id) {
      if (!confirm("Yakin ingin menghapus user ini?")) return;

      try {
        const res = await fetch(`/api/users/${id}`, {
          method: "DELETE",
          headers,
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.message);
        alert("✅ " + result.message);
        loadUsers();
      } catch (err) {
        console.error("❌ Delete user error:", err);
        alert("❌ Gagal menghapus user.");
      }
    };

    // =====================================================
    // 🔄 RESET FORM
    // =====================================================
    resetBtn.addEventListener("click", () => {
      editId = null;
      userForm.reset();
      formTitle.textContent = "Tambah User";
      saveBtn.textContent = "💾 Simpan";
      formMsg.textContent = "";
    });

    // 🚀 INIT
    loadUsers();
  </script>
</body>
</html>