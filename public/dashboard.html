<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Travel Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 transition-all duration-300" id="appBody">

  <!-- Sidebar -->
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="bg-indigo-700 text-white w-64 flex-shrink-0 flex flex-col transition-all duration-300">
      <div class="px-6 py-4 flex justify-between items-center border-b border-indigo-500">
        <h2 class="text-xl font-bold">🌍 Travel Dashboard</h2>
        <button id="toggleSidebar" class="text-indigo-200 hover:text-white focus:outline-none">⏩</button>
      </div>

      <nav class="flex-1 px-4 py-6 space-y-2">
        <a href="/dashboard" class="block py-2 px-3 rounded hover:bg-indigo-600">🏠 Dashboard</a>
        <a href="/users" class="block py-2 px-3 rounded hover:bg-indigo-600">👥 User Management</a>
        <a href="/profile" class="block py-2 px-3 rounded hover:bg-indigo-600">👤 Profile</a>
        <a href="/tours.html" class="block py-2 px-3 rounded hover:bg-indigo-600">🧳 Tours</a>
        <a href="/reports.html" class="block py-2 px-3 rounded hover:bg-indigo-600">📊 Reports</a>
      </nav>

      <div class="p-4 border-t border-indigo-500 flex justify-between items-center">
        <button id="themeToggle" class="bg-indigo-500 px-3 py-1 rounded hover:bg-indigo-400">🌞 / 🌙</button>
        <button id="logoutBtn" class="bg-red-500 px-3 py-1 rounded hover:bg-red-600">Keluar</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-semibold">📊 Dashboard Overview</h1>
        <span id="userInfo" class="text-gray-600 text-sm"></span>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow transition-colors">
          <h3 class="font-semibold text-gray-600 dark:text-gray-300">Total Tours</h3>
          <p id="totalTours" class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mt-2">0</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow transition-colors">
          <h3 class="font-semibold text-gray-600 dark:text-gray-300">Total Sales (IDR)</h3>
          <p id="totalSales" class="text-3xl font-bold text-green-600 dark:text-green-400 mt-2">0</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow transition-colors">
          <h3 class="font-semibold text-gray-600 dark:text-gray-300">Total Profit (IDR)</h3>
          <p id="totalProfit" class="text-3xl font-bold text-emerald-600 dark:text-emerald-400 mt-2">0</p>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow transition-colors">
          <h3 class="font-semibold text-gray-600 dark:text-gray-300 mb-2">Status Keberangkatan Tour</h3>
          <canvas id="tourStatusChart"></canvas>
        </div>

        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow transition-colors">
          <h3 class="font-semibold text-gray-600 dark:text-gray-300 mb-2">Sales vs Profit</h3>
          <canvas id="salesChart"></canvas>
        </div>
      </div>
    </main>
  </div>

  <script>
    // --- JWT + User Check ---
    const token = localStorage.getItem("travel_token");
    const user = JSON.parse(localStorage.getItem("travel_user") || "{}");

    if (!token || !user.username) {
      window.location.href = "/login";
    }

    document.getElementById("userInfo").textContent = `${user.name || user.username} (${user.type})`;

    // --- Logout ---
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "/login";
    });

    // --- Sidebar Collapse ---
    const sidebar = document.getElementById("sidebar");
    document.getElementById("toggleSidebar").addEventListener("click", () => {
      sidebar.classList.toggle("w-64");
      sidebar.classList.toggle("w-20");
    });

    // --- Dark Mode Toggle ---
    const themeToggle = document.getElementById("themeToggle");
    const appBody = document.getElementById("appBody");
    const currentTheme = localStorage.getItem("theme");

    if (currentTheme === "dark") appBody.classList.add("dark", "bg-gray-900", "text-gray-100");

    themeToggle.addEventListener("click", () => {
      if (appBody.classList.contains("dark")) {
        appBody.classList.remove("dark", "bg-gray-900", "text-gray-100");
        localStorage.setItem("theme", "light");
      } else {
        appBody.classList.add("dark", "bg-gray-900", "text-gray-100");
        localStorage.setItem("theme", "dark");
      }
    });

    // --- Load Dashboard Data ---
    async function loadDashboard() {
      try {
        const res = await fetch("/api/dashboard/executive", {
          headers: { Authorization: "Bearer " + token }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Gagal memuat data.");

        document.getElementById("totalTours").textContent = data.tours.totalTours || 0;
        document.getElementById("totalSales").textContent = new Intl.NumberFormat("id-ID").format(data.sales.totalSales || 0);
        document.getElementById("totalProfit").textContent = new Intl.NumberFormat("id-ID").format(data.sales.totalProfit || 0);

        renderCharts(data);
      } catch (err) {
        console.error("Dashboard error:", err.message);
      }
    }

    function renderCharts(data) {
      // Tour Status Chart
      new Chart(document.getElementById("tourStatusChart"), {
        type: "pie",
        data: {
          labels: data.tourByStatus.map(s => s.departureStatus),
          datasets: [{
            data: data.tourByStatus.map(s => s.total),
            backgroundColor: ["#16a34a", "#f59e0b", "#ef4444"],
          }]
        },
        options: { responsive: true }
      });

      // Sales Chart
      new Chart(document.getElementById("salesChart"), {
        type: "bar",
        data: {
          labels: ["Sales", "Profit"],
          datasets: [{
            data: [data.sales.totalSales || 0, data.sales.totalProfit || 0],
            backgroundColor: ["#4f46e5", "#22c55e"]
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }

    loadDashboard();
  </script>
</body>
</html>
