<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Travel Dashboard Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="color-scheme" content="light dark" />
  </head>

  <body class="min-h-screen bg-gray-50 flex flex-col">
    <!-- Navbar -->
    <header class="bg-white shadow-md py-3 px-6 flex justify-between items-center">
      <h1 class="text-lg font-bold text-indigo-700">Travel Dashboard Enterprise</h1>
      <div class="flex items-center gap-4">
        <span id="userNameDisplay" class="text-sm text-gray-600 font-medium">Loading...</span>
        <button
          data-logout
          class="text-sm text-red-600 hover:text-red-700 font-semibold transition"
        >
          Logout
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-6">
      <!-- Health / Backend Banner -->
      <div
        id="backendStatusBanner"
        class="hidden bg-yellow-100 text-yellow-800 p-2 text-sm rounded mb-4"
      ></div>

      <!-- Summary Cards -->
      <div class="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 mb-8">
        <div class="bg-white shadow rounded-xl p-5 border border-gray-100">
          <h3 class="text-sm font-medium text-gray-500 mb-1">Total Sales</h3>
          <p id="totalSales" class="text-2xl font-bold text-indigo-600">0</p>
        </div>
        <div class="bg-white shadow rounded-xl p-5 border border-gray-100">
          <h3 class="text-sm font-medium text-gray-500 mb-1">Total Profit</h3>
          <p id="totalProfit" class="text-2xl font-bold text-green-600">0</p>
        </div>
        <div class="bg-white shadow rounded-xl p-5 border border-gray-100">
          <h3 class="text-sm font-medium text-gray-500 mb-1">Total Pax</h3>
          <p id="totalPax" class="text-2xl font-bold text-sky-600">0</p>
        </div>
        <div class="bg-white shadow rounded-xl p-5 border border-gray-100">
          <h3 class="text-sm font-medium text-gray-500 mb-1">Total Registrants</h3>
          <p id="totalRegistrants" class="text-2xl font-bold text-amber-600">0</p>
        </div>
      </div>

      <!-- Charts Section -->
      <section class="bg-white rounded-xl shadow p-6 border border-gray-100 mb-8">
        <h2 class="text-lg font-semibold text-gray-700 mb-3">Grafik Sales & Profit</h2>
        <canvas id="salesChart" height="120"></canvas>
      </section>

      <!-- Recent Activity -->
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white shadow rounded-xl p-6 border border-gray-100">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Tour Terbaru</h3>
          <table class="w-full text-sm text-left">
            <thead>
              <tr class="border-b text-gray-600">
                <th class="py-2">Tour Code</th>
                <th>Lead Passenger</th>
                <th>Region</th>
                <th>Sales</th>
              </tr>
            </thead>
            <tbody id="recentTours" class="text-gray-700"></tbody>
          </table>
        </div>

        <div class="bg-white shadow rounded-xl p-6 border border-gray-100">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Sales Terbaru</h3>
          <table class="w-full text-sm text-left">
            <thead>
              <tr class="border-b text-gray-600">
                <th class="py-2">Invoice</th>
                <th>Tanggal</th>
                <th>Sales</th>
                <th>Profit</th>
              </tr>
            </thead>
            <tbody id="recentSales" class="text-gray-700"></tbody>
          </table>
        </div>
      </section>
    </main>

    <footer class="text-center py-3 text-xs text-gray-400 border-t">
      Â© 2025 Travel Dashboard Enterprise v3.4.1
    </footer>

    <!-- External JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/app.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        // Load summary data
        try {
          const data = await apiFetch("/api/dashboard/summary");
          if (data && data.totals) {
            document.getElementById("totalSales").textContent = formatNumber(data.totals.totalSalesTours);
            document.getElementById("totalProfit").textContent = formatNumber(data.totals.totalProfitTours);
            document.getElementById("totalPax").textContent = formatNumber(data.totals.totalPax);
            document.getElementById("totalRegistrants").textContent = formatNumber(data.totals.totalRegistrants);
          }
        } catch (err) {
          showToast("Gagal memuat ringkasan dashboard", { type: "error" });
        }

        // Load chart data
        try {
          const chartRes = await apiFetch("/api/dashboard/chart-data");
          const ctx = document.getElementById("salesChart");
          const months = chartRes.chart.map((r) => r.month);
          const sales = chartRes.chart.map((r) => r.total_sales);
          const profit = chartRes.chart.map((r) => r.total_profit);

          new Chart(ctx, {
            type: "line",
            data: {
              labels: months,
              datasets: [
                { label: "Sales", data: sales, borderWidth: 2, borderColor: "#4F46E5", tension: 0.2 },
                { label: "Profit", data: profit, borderWidth: 2, borderColor: "#16A34A", tension: 0.2 },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: true, position: "bottom" } },
              scales: { y: { beginAtZero: true } },
            },
          });
        } catch (err) {
          console.error("Chart load error:", err);
        }

        // Load recent data
        try {
          const recent = await apiFetch("/api/dashboard/recent");
          const toursBody = document.getElementById("recentTours");
          const salesBody = document.getElementById("recentSales");

          toursBody.innerHTML = recent.recentTours
            .map(
              (t) => `
              <tr class="border-b hover:bg-gray-50">
                <td class="py-1">${t.tourcode || "-"}</td>
                <td>${t.leadpassenger || "-"}</td>
                <td>${t.region || "-"}</td>
                <td>${formatNumber(t.salesamount)}</td>
              </tr>`
            )
            .join("");

          salesBody.innerHTML = recent.recentSales
            .map(
              (s) => `
              <tr class="border-b hover:bg-gray-50">
                <td class="py-1">${s.invoice_number || "-"}</td>
                <td>${s.transaction_date || "-"}</td>
                <td>${formatNumber(s.sales_amount)}</td>
                <td>${formatNumber(s.profit_amount)}</td>
              </tr>`
            )
            .join("");
        } catch (err) {
          showToast("Gagal memuat data terbaru", { type: "error" });
        }
      });
    </script>
  </body>
</html>
