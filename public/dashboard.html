<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Travel Dashboard</title>

  <!-- TailwindCSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

  <!-- Navbar -->
  <nav class="bg-indigo-600 text-white px-6 py-3 flex justify-between items-center shadow-md">
    <div class="flex items-center gap-2">
      <h1 class="text-xl font-semibold">🏝️ Travel Dashboard</h1>
    </div>
    <div class="flex items-center gap-4">
      <span id="userInfo" class="text-sm"></span>
      <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm">Keluar</button>
    </div>
  </nav>

  <!-- Content -->
  <main class="flex-1 container mx-auto px-6 py-8">
    <h2 class="text-2xl font-semibold mb-6">📊 Ringkasan Data</h2>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="font-semibold text-gray-600">Total Tour</h3>
        <p id="totalTours" class="text-3xl font-bold text-indigo-600 mt-2">0</p>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="font-semibold text-gray-600">Total Sales (IDR)</h3>
        <p id="totalSales" class="text-3xl font-bold text-green-600 mt-2">0</p>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="font-semibold text-gray-600">Total Profit (IDR)</h3>
        <p id="totalProfit" class="text-3xl font-bold text-emerald-600 mt-2">0</p>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded-lg shadow">
        <h3 class="font-semibold text-gray-600 mb-2">Status Keberangkatan Tour</h3>
        <canvas id="tourStatusChart"></canvas>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <h3 class="font-semibold text-gray-600 mb-2">Sales & Profit Overview</h3>
        <canvas id="salesChart"></canvas>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white text-center text-sm text-gray-500 py-4 border-t">
    &copy; 2025 Travel Dashboard Enterprise v2.0 — Build by Raden Cakra
  </footer>

  <script>
    const token = localStorage.getItem("travel_token");
    const user = JSON.parse(localStorage.getItem("travel_user") || "{}");
    const API = "/api/dashboard/executive";

    // =======================================================
    // 🧩 Auth Check
    // =======================================================
    if (!token || !user.username) {
      localStorage.clear();
      window.location.href = "/login";
    }

    document.getElementById("userInfo").textContent = `${user.name || user.username} (${user.type})`;

    // =======================================================
    // 🚪 Logout
    // =======================================================
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "/login";
    });

    // =======================================================
    // 📊 Load Dashboard Summary
    // =======================================================
    async function loadDashboard() {
      try {
        const res = await fetch(API, { headers: { Authorization: "Bearer " + token } });
        const data = await res.json();

        if (!res.ok || !data) throw new Error(data.error || "Gagal memuat data.");

        // Summary Data
        document.getElementById("totalTours").textContent = data.tours.totalTours || 0;
        document.getElementById("totalSales").textContent = new Intl.NumberFormat("id-ID").format(data.sales.totalSales || 0);
        document.getElementById("totalProfit").textContent = new Intl.NumberFormat("id-ID").format(data.sales.totalProfit || 0);

        renderCharts(data);
      } catch (err) {
        console.error("Dashboard error:", err.message);
        localStorage.clear();
        window.location.href = "/login";
      }
    }

    // =======================================================
    // 📈 Charts
    // =======================================================
    function renderCharts(data) {
      // Tour Status Chart
      const ctxTour = document.getElementById("tourStatusChart").getContext("2d");
      new Chart(ctxTour, {
        type: "pie",
        data: {
          labels: data.tourByStatus.map(s => s.departureStatus),
          datasets: [{
            data: data.tourByStatus.map(s => s.total),
            backgroundColor: ["#16a34a", "#f59e0b", "#ef4444"],
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } }
        }
      });

      // Sales Chart
      const ctxSales = document.getElementById("salesChart").getContext("2d");
      new Chart(ctxSales, {
        type: "bar",
        data: {
          labels: ["Sales", "Profit"],
          datasets: [{
            data: [data.sales.totalSales || 0, data.sales.totalProfit || 0],
            backgroundColor: ["#4f46e5", "#22c55e"],
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { callback: val => "Rp " + val.toLocaleString("id-ID") } }
          }
        }
      });
    }

    // =======================================================
    // 🕒 Auto Refresh every 5 minutes
    // =======================================================
    loadDashboard();
    setInterval(loadDashboard, 5 * 60 * 1000);
  </script>
</body>
</html>
