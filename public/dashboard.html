<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Tour & Sales</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-7xl mx-auto mt-10 p-6">

    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">ðŸ“Š Dashboard Tour & Sales</h1>
      <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Logout</button>
    </div>

    <p id="userInfo" class="mb-4 text-gray-700"></p>

    <!-- Menu Admin / Staff -->
    <div class="flex gap-4 mb-6">
      <button class="nav-item bg-blue-600 text-white px-4 py-2 rounded" onclick="showPage('tourData')">Data Tour</button>
      <button class="nav-item bg-green-600 text-white px-4 py-2 rounded" onclick="showPage('salesData')">Data Sales</button>
    </div>

    <!-- ===================== PAGES ===================== -->
    <div id="tourData" class="hidden">
      <h2 class="text-2xl font-bold mb-4">ðŸ“… Data Tour</h2>
      <table class="w-full border mb-6">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2 text-left">Judul</th>
            <th class="p-2 text-left">Deskripsi</th>
            <th class="p-2 text-left">Harga</th>
            <th class="p-2 text-left">Tanggal</th>
            <th class="p-2 text-center">Aksi</th>
          </tr>
        </thead>
        <tbody id="tourTable"></tbody>
      </table>

      <canvas id="tourChart" height="100"></canvas>
    </div>

    <div id="salesData" class="hidden">
      <h2 class="text-2xl font-bold mb-4">ðŸ’¼ Data Sales</h2>
      <table class="w-full border mb-6">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2 text-left">Customer</th>
            <th class="p-2 text-left">Produk</th>
            <th class="p-2 text-left">Jumlah</th>
            <th class="p-2 text-left">Tanggal</th>
            <th class="p-2 text-center">Aksi</th>
          </tr>
        </thead>
        <tbody id="salesTable"></tbody>
      </table>

      <canvas id="salesChart" height="100"></canvas>
    </div>
  </div>

  <script src="/js/config.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/tours.js"></script>
  <script src="/js/sales.js"></script>
  <script src="/js/app.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      const userInfo = document.getElementById('userInfo');
      const logoutBtn = document.getElementById('logoutBtn');

      if (!token) {
        window.location.href = '/';
        return;
      }

      // Tampilkan info user
      const username = localStorage.getItem('username') || 'User';
      userInfo.textContent = `Selamat datang, ${username}`;

      // Logout
      logoutBtn?.addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        window.location.reload();
      });

      // Load data awal
      await loadTours();
      await loadSales();
      await loadTourChart();
      await loadSalesChart();
    });

    // ===================== PAGE NAVIGATION =====================
    function showPage(page) {
      const pages = { tourData: 'tourData', salesData: 'salesData' };
      Object.values(pages).forEach(id => document.getElementById(id)?.classList.add('hidden'));
      document.getElementById(pages[page])?.classList.remove('hidden');
    }

    // ===================== TOUR CHART =====================
    let tourChartInstance = null;
    async function loadTourChart() {
      try {
        const tours = await apiRequest('/tours');
        const labels = tours.map(t => t.date);
        const prices = tours.map(t => t.price);

        const ctx = document.getElementById('tourChart').getContext('2d');
        if (tourChartInstance) tourChartInstance.destroy();

        tourChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Harga Tour (Rp)',
              data: prices,
              backgroundColor: 'rgba(59, 130, 246, 0.6)',
              borderColor: 'rgba(59, 130, 246, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, title: { display: true, text: 'Harga (Rp)' } },
              x: { title: { display: true, text: 'Tanggal' } }
            }
          }
        });
      } catch (err) {
        showErrorToast("Gagal memuat chart tour: " + err.message);
      }
    }
  </script>
</body>
</html>
