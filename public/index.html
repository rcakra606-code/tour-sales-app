<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard — Travel Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="https://unpkg.com/lucide@0.260.0/dist/esm/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      overflow-x: hidden;
      transition: background 0.3s ease;
    }
    :root {
      --bg: #f8fafc;
      --text: #0f172a;
    }
    [data-theme="dark"] {
      --bg: #0b1220;
      --text: #e2e8f0;
    }
    .fade-in { animation: fadeIn 0.5s ease forwards; opacity: 0; }
    .fade-out { animation: fadeOut 0.4s ease forwards; }
    @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
    @keyframes fadeOut { from {opacity: 1;} to {opacity: 0;} }
    .hidden { display: none !important; }
  </style>
</head>
<body data-theme="light" class="min-h-screen text-[var(--text)]">

  <!-- LOADING SCREEN -->
  <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-white dark:bg-slate-900 z-50">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
    <p class="text-sm text-slate-500 dark:text-slate-400">Memuat dashboard...</p>
  </div>

  <!-- APP WRAPPER -->
  <div id="app-wrapper" class="hidden opacity-0 fade-in transition-opacity duration-300">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed lg:static top-0 left-0 w-64 min-h-screen bg-white dark:bg-slate-900 border-r p-5 hidden lg:flex flex-col">
      <div class="mb-6">
        <h1 class="text-xl font-bold text-indigo-600 dark:text-indigo-400">Travel Dashboard</h1>
        <p class="text-xs text-slate-500 dark:text-slate-400">Manage tours & reports</p>
      </div>
      <nav id="nav-links" class="space-y-2 text-sm">
        <button data-route="dashboard" class="nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-indigo-50 dark:hover:bg-slate-800 active">Dashboard</button>
        <button data-route="tours" class="nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-indigo-50 dark:hover:bg-slate-800">Tours</button>
        <button data-route="sales" class="nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-indigo-50 dark:hover:bg-slate-800">Sales</button>
        <button data-route="documents" class="nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-indigo-50 dark:hover:bg-slate-800">Documents</button>
        <button data-route="reports" class="nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-indigo-50 dark:hover:bg-slate-800">Reports</button>
        <button data-route="users" class="nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-indigo-50 dark:hover:bg-slate-800">Manage Users</button>
      </nav>
      <div class="mt-auto border-t pt-4">
        <button id="btn-logout" class="w-full text-left px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg">Logout</button>
        <div class="flex items-center justify-between mt-3">
          <label class="text-xs flex items-center gap-2">
            <input id="toggle-theme" type="checkbox" class="w-4 h-4">
            Dark Mode
          </label>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="lg:ml-64 min-h-screen flex flex-col transition-all duration-300">

      <!-- HEADER -->
      <header class="flex items-center justify-between p-4 border-b bg-white dark:bg-slate-900 sticky top-0 z-40">
        <div>
          <h2 id="page-title" class="text-lg font-semibold">Dashboard</h2>
          <p id="page-sub" class="text-xs text-slate-500 dark:text-slate-400">Overview & quick summary</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="text-right">
            <div id="user-name" class="font-medium">—</div>
            <div id="user-role" class="text-xs text-slate-500 dark:text-slate-400">—</div>
            <button id="btn-open-change-password" class="text-[11px] text-indigo-500 hover:underline">Ubah Password</button>
          </div>
        </div>
      </header>

      <!-- PAGE CONTENT -->
      <main id="content" class="flex-1 p-6 space-y-6">
        <!-- view content injected dynamically -->
        <div id="view-dashboard" class="fade-in">
          <div class="grid md:grid-cols-3 gap-4">
            <div class="p-4 bg-white dark:bg-slate-800 rounded-lg shadow-sm">
              <div class="text-xs text-slate-500">Total Tours</div>
              <div id="total-tours" class="text-2xl font-bold mt-2">—</div>
            </div>
            <div class="p-4 bg-white dark:bg-slate-800 rounded-lg shadow-sm">
              <div class="text-xs text-slate-500">Total Sales</div>
              <div id="total-sales" class="text-2xl font-bold mt-2">—</div>
            </div>
            <div class="p-4 bg-white dark:bg-slate-800 rounded-lg shadow-sm">
              <div class="text-xs text-slate-500">Total Profit</div>
              <div id="total-profit" class="text-2xl font-bold mt-2">—</div>
            </div>
          </div>
          <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm mt-6">
            <h3 class="font-semibold mb-2">Sales Overview</h3>
            <canvas id="salesChart" height="120"></canvas>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed right-6 bottom-6 hidden"></div>

  <script>
    /* ============= CONFIG ============= */
    const API_BASE = '';
    const tokenKey = 'travel_token';
    const userKey = 'travel_user';
    const refreshKey = 'travel_refresh';
    const loadingScreen = document.getElementById('loading-screen');
    const appWrapper = document.getElementById('app-wrapper');

    /* ============= HELPERS ============= */
    function showToast(msg, type='info') {
      const t = document.getElementById('toast');
      t.innerHTML = msg;
      t.className = 'fixed right-6 bottom-6 px-3 py-2 rounded shadow-lg text-white fade-in ' + 
        (type === 'error' ? 'bg-red-600' : 'bg-slate-800');
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 3000);
    }

    async function apiFetch(method, path, body) {
      const headers = { 'Content-Type': 'application/json' };
      const token = localStorage.getItem(tokenKey);
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const opts = { method, headers };
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(API_BASE + path, opts);
      if (res.status === 401) {
        handleLogout('Sesi Anda berakhir. Silakan login kembali.');
        throw new Error('Unauthorized');
      }
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) return res.json();
      return res;
    }

    function fadeInDashboard() {
      loadingScreen.classList.add('fade-out');
      setTimeout(() => {
        loadingScreen.remove();
        appWrapper.classList.remove('hidden');
        appWrapper.classList.add('opacity-100');
      }, 400);
    }

    /* ============= TOKEN CHECK ============= */
    async function verifyToken() {
      const token = localStorage.getItem(tokenKey);
      if (!token) return false;
      try {
        const res = await fetch('/api/auth/verify', {
          headers: { Authorization: 'Bearer ' + token }
        });
        const data = await res.json();
        return data.valid;
      } catch {
        return false;
      }
    }

    async function initApp() {
      const valid = await verifyToken();
      if (!valid) {
        window.location.href = '/login.html';
        return;
      }

      fadeInDashboard();
      const user = JSON.parse(localStorage.getItem(userKey) || '{}');
      document.getElementById('user-name').textContent = user.name || user.username;
      document.getElementById('user-role').textContent = user.type || '';
      loadDashboardSummary();
    }

    /* ============= DASHBOARD DATA ============= */
    async function loadDashboardSummary() {
      try {
        const res = await apiFetch('GET', '/api/dashboard/summary');
        document.getElementById('total-tours').textContent = res.totalTours ?? 0;
        document.getElementById('total-sales').textContent = new Intl.NumberFormat('id-ID').format(res.totalSales ?? 0);
        document.getElementById('total-profit').textContent = new Intl.NumberFormat('id-ID').format(res.totalProfit ?? 0);
        renderSalesChart(res.salesSeries || []);
      } catch (err) {
        showToast('Gagal memuat data dashboard', 'error');
      }
    }

    function renderSalesChart(series) {
      const ctx = document.getElementById('salesChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: series.map(s => s.date),
          datasets: [{
            label: 'Sales',
            data: series.map(s => s.amount),
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79,70,229,0.2)',
            tension: 0.3,
            fill: true
          }]
        },
        options: { plugins: { legend: { display: false } } }
      });
    }

    /* ============= LOGOUT ============= */
    function handleLogout(message) {
      showToast(message || 'Logout berhasil');
      localStorage.removeItem(tokenKey);
      localStorage.removeItem(refreshKey);
      localStorage.removeItem(userKey);
      appWrapper.classList.add('fade-out');
      setTimeout(() => window.location.href = '/login.html', 800);
    }

    document.getElementById('btn-logout').addEventListener('click', () => handleLogout());

    /* ============= THEME ============= */
    const toggleTheme = document.getElementById('toggle-theme');
    function applyTheme() {
      const t = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', t);
      toggleTheme.checked = t === 'dark';
    }
    toggleTheme.addEventListener('change', () => {
      const t = toggleTheme.checked ? 'dark' : 'light';
      localStorage.setItem('theme', t);
      applyTheme();
    });
    applyTheme();

    /* ============= INIT ============= */
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
