<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laporan Penjualan | Travel Dashboard</title>
  <link rel="stylesheet" href="./css/style.css" />
  <script defer src="./js/ui.js"></script>
</head>
<body class="light-mode">
  <!-- ===================================================== -->
  <!-- 🧭 SIDEBAR -->
  <!-- ===================================================== -->
  <aside id="sidebar" class="sidebar expanded">
    <div class="sidebar-header">
      <h2>Travel Dashboard</h2>
      <button id="toggleSidebar">☰</button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="dashboard.html">🏠 Dashboard</a></li>
      <li class="active"><a href="report_sales.html">💹 Laporan Sales</a></li>
      <li><a href="report_tour.html">✈️ Laporan Tour</a></li>
      <li><a href="report_document.html">📑 Laporan Dokumen</a></li>
      <li><a href="user-management.html">👥 User Management</a></li>
      <li><a href="profile.html">👤 Profil</a></li>
      <li><a href="login.html" id="logoutBtn">🚪 Logout</a></li>
    </ul>
    <div class="theme-toggle">
      <span>🌞</span>
      <label class="switch">
        <input type="checkbox" id="themeSwitch">
        <span class="slider round"></span>
      </label>
      <span>🌙</span>
    </div>
  </aside>

  <!-- ===================================================== -->
  <!-- 📊 MAIN CONTENT -->
  <!-- ===================================================== -->
  <main id="main-content">
    <header>
      <h1>💹 Laporan Penjualan</h1>
      <p>Data rekap transaksi penjualan dan profit per staff</p>
    </header>

    <!-- 🔍 FILTERS -->
    <section class="filters">
      <input type="text" id="staffFilter" placeholder="Cari nama staff..." />
      <input type="month" id="monthFilter" />
      <button id="filterBtn">Terapkan Filter</button>
      <div class="export-buttons">
        <button id="exportExcel">📘 Export Excel</button>
        <button id="exportCSV">📄 Export CSV</button>
      </div>
    </section>

    <!-- 📋 TABLE -->
    <section class="table-section">
      <table id="salesTable">
        <thead>
          <tr>
            <th>No</th>
            <th>Nama Staff</th>
            <th>Tanggal Transaksi</th>
            <th>Nomor Invoice</th>
            <th>Sales (Rp)</th>
            <th>Profit (Rp)</th>
            <th>Keterangan</th>
          </tr>
        </thead>
        <tbody id="salesTableBody">
          <tr><td colspan="7" class="center">Memuat data...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <!-- ===================================================== -->
  <!-- 📜 SCRIPT -->
  <!-- ===================================================== -->
  <script>
    const token = localStorage.getItem("token");
    const headers = { "Authorization": \`Bearer \${token}\` };

    async function fetchSalesData(staff = "", month = "") {
      try {
        const response = await fetch("/api/report/sales", { headers });
        const data = await response.json();

        let filtered = data;
        if (staff) {
          filtered = filtered.filter((r) =>
            r.staff_name.toLowerCase().includes(staff.toLowerCase())
          );
        }
        if (month) {
          const monthYear = month.split("-");
          filtered = filtered.filter((r) => {
            const date = new Date(r.transaction_date);
            return (
              date.getFullYear() === parseInt(monthYear[0]) &&
              date.getMonth() + 1 === parseInt(monthYear[1])
            );
          });
        }

        const tbody = document.getElementById("salesTableBody");
        tbody.innerHTML = "";

        if (filtered.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="center">Tidak ada data ditemukan.</td></tr>';
          return;
        }

        filtered.forEach((row, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${row.staff_name || "-"}</td>
            <td>${new Date(row.transaction_date).toLocaleDateString("id-ID")}</td>
            <td>${row.invoice_number || "-"}</td>
            <td>Rp ${Number(row.sales_amount || 0).toLocaleString("id-ID")}</td>
            <td>Rp ${Number(row.profit_amount || 0).toLocaleString("id-ID")}</td>
            <td>${row.remarks || "-"}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("❌ Error memuat data sales:", err);
      }
    }

    document.getElementById("filterBtn").addEventListener("click", () => {
      const staff = document.getElementById("staffFilter").value;
      const month = document.getElementById("monthFilter").value;
      fetchSalesData(staff, month);
    });

    document.getElementById("exportExcel").addEventListener("click", () => {
      window.open("/api/report/sales/export?format=xlsx", "_blank");
    });

    document.getElementById("exportCSV").addEventListener("click", () => {
      window.open("/api/report/sales/export?format=csv", "_blank");
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });

    // Jalankan saat load pertama
    fetchSalesData();
  </script>
</body>
</html>