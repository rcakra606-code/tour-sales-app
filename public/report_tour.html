<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Report Tour - Travel Dashboard Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="color-scheme" content="light dark" />
  </head>

  <body class="min-h-screen bg-gray-50 flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow px-6 py-3 flex justify-between items-center">
      <h1 class="font-bold text-lg text-indigo-700">Report Tour</h1>
      <div class="flex items-center gap-4">
        <span id="userNameDisplay" class="text-sm text-gray-600">Loading...</span>
        <button data-logout class="text-sm text-red-600 font-semibold hover:underline">
          Logout
        </button>
      </div>
    </header>

    <main class="flex-1 p-6">
      <div id="backendStatusBanner"
           class="hidden bg-yellow-100 text-yellow-800 p-2 text-sm rounded mb-4"></div>

      <!-- Form Tambah / Edit -->
      <section class="bg-white rounded-xl shadow p-6 border border-gray-100 mb-8">
        <h2 class="text-lg font-semibold mb-4 text-gray-700">Tambah / Edit Data Tour</h2>
        <form id="tourForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium">Tanggal Registrasi</label>
            <input type="date" id="registrationDate"
                   class="w-full border rounded-lg px-3 py-2 mt-1" />
          </div>
          <div>
            <label class="text-sm font-medium">Lead Passenger</label>
            <input type="text" id="leadPassenger"
                   class="w-full border rounded-lg px-3 py-2 mt-1" />
          </div>
          <div>
            <label class="text-sm font-medium">All Passengers (pisahkan dengan koma)</label>
            <input type="text" id="allPassengers"
                   class="w-full border rounded-lg px-3 py-2 mt-1" />
          </div>
          <div>
            <label class="text-sm font-medium">Tour Code</label>
            <input type="text" id="tourCode"
                   class="w-full border rounded-lg px-3 py-2 mt-1" />
          </div>
          <div>
            <label class="text-sm font-medium">Region</label>
            <input type="text" id="region"
                   placeholder="Cari region..."
                   class="w-full border rounded-lg px-3 py-2 mt-1" />
          </div>
          <div>
            <label class="text-sm font-medium">Tanggal Keberangkatan</label>
            <input type="date" id="departureDate"
                   class="w-full border rounded-lg px-3 py-2 mt-1" />
          </div>
          <div>
            <label class="text-sm font-medium">Booking Code</label>
            <input type="text" id="bookingCode"
                   class="w-full border rounded-lg px-3 py-2 mt-1" />
          </div>
          <div>
            <label class="text-sm font-medium">Harga Tour</label>
            <input type="number" id="tourPrice"
                   class="w-full border rounded-lg px-3 py-2 mt-1" />
          </div>
          <div>
            <label class="text-sm font-medium">Sales Amount</label>
            <input type="number" id="salesAmount"
                   class="w-full border rounded-lg px-3 py-2 mt-1" />
          </div>
          <div>
            <label class="text-sm font-medium">Profit Amount</label>
            <input type="number" id="profitAmount"
                   class="w-full border rounded-lg px-3 py-2 mt-1" />
          </div>
          <div>
            <label class="text-sm font-medium">Departure Status</label>
            <select id="departureStatus"
                    class="w-full border rounded-lg px-3 py-2 mt-1">
              <option value="PENDING">PENDING</option>
              <option value="CONFIRMED">CONFIRMED</option>
              <option value="CANCELLED">CANCELLED</option>
            </select>
          </div>

          <div class="col-span-1 md:col-span-2 flex gap-3 mt-4">
            <button type="submit"
                    class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
              Simpan
            </button>
            <button type="button" id="resetBtn"
                    class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">
              Reset
            </button>
          </div>
        </form>
      </section>

      <!-- Data Table -->
      <section class="bg-white rounded-xl shadow p-6 border border-gray-100">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold text-gray-700">Daftar Tour</h2>
          <button id="refreshBtn"
                  class="text-sm bg-indigo-100 text-indigo-700 px-3 py-1 rounded hover:bg-indigo-200">
            Refresh
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left border">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="py-2 px-2">#</th>
                <th>Tour Code</th>
                <th>Lead Passenger</th>
                <th>Region</th>
                <th>Departure</th>
                <th>Sales</th>
                <th>Profit</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="tourTable" class="text-gray-700"></tbody>
          </table>
        </div>
      </section>
    </main>

    <footer class="text-center text-xs text-gray-400 py-3 border-t">
      ¬© 2025 Travel Dashboard Enterprise v3.4.1
    </footer>

    <script src="/js/app.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("tourForm");
        const resetBtn = document.getElementById("resetBtn");
        const tableBody = document.getElementById("tourTable");
        const refreshBtn = document.getElementById("refreshBtn");
        let editId = null;

        async function loadTours() {
          try {
            const data = await apiFetch("/api/tours");
            tableBody.innerHTML = data
              .map(
                (t, i) => `
                <tr class="border-b hover:bg-gray-50">
                  <td class="py-1 px-2">${i + 1}</td>
                  <td>${t.tourcode || "-"}</td>
                  <td>${t.leadpassenger || "-"}</td>
                  <td>${t.region || "-"}</td>
                  <td>${t.departuredate || "-"}</td>
                  <td>${formatNumber(t.salesamount)}</td>
                  <td>${formatNumber(t.profitamount)}</td>
                  <td>${t.departurestatus || "-"}</td>
                  <td class="flex gap-2">
                    <button class="text-blue-600 hover:underline" data-edit="${t.id}">Edit</button>
                    <button class="text-red-600 hover:underline" data-delete="${t.id}">Hapus</button>
                  </td>
                </tr>`
              )
              .join("");
          } catch (err) {
            console.error(err);
            showToast("Gagal memuat data tour", { type: "error" });
          }
        }

        // load all tours initially
        loadTours();

        // handle form submit
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const payload = {
            registrationDate: form.registrationDate.value,
            leadPassenger: form.leadPassenger.value,
            allPassengers: form.allPassengers.value,
            tourCode: form.tourCode.value,
            region: form.region.value,
            departureDate: form.departureDate.value,
            bookingCode: form.bookingCode.value,
            tourPrice: form.tourPrice.value,
            salesAmount: form.salesAmount.value,
            profitAmount: form.profitAmount.value,
            departureStatus: form.departureStatus.value,
          };

          try {
            if (editId) {
              await apiFetch(`/api/tours/${editId}`, {
                method: "PUT",
                body: JSON.stringify(payload),
              });
              showToast("‚úÖ Data tour diperbarui", { type: "success" });
            } else {
              await apiFetch("/api/tours", {
                method: "POST",
                body: JSON.stringify(payload),
              });
              showToast("‚úÖ Data tour ditambahkan", { type: "success" });
            }
            editId = null;
            form.reset();
            loadTours();
          } catch (err) {
            console.error(err);
            showToast("‚ùå Gagal menyimpan data", { type: "error" });
          }
        });

        // reset form
        resetBtn.addEventListener("click", () => {
          form.reset();
          editId = null;
        });

        // refresh data
        refreshBtn.addEventListener("click", loadTours);

        // handle edit/delete
        tableBody.addEventListener("click", async (e) => {
          const id = e.target.dataset.edit || e.target.dataset.delete;
          if (!id) return;

          if (e.target.dataset.edit) {
            try {
              const tour = await apiFetch(`/api/tours/${id}`);
              Object.keys(tour).forEach((key) => {
                if (form[key]) form[key].value = tour[key];
              });
              editId = id;
              showToast("‚úèÔ∏è Mode edit aktif", { type: "info" });
            } catch (err) {
              showToast("Gagal memuat data untuk edit", { type: "error" });
            }
          }

          if (e.target.dataset.delete) {
            if (!confirm("Yakin ingin menghapus data ini?")) return;
            try {
              await apiFetch(`/api/tours/${id}`, { method: "DELETE" });
              showToast("üóëÔ∏è Data tour dihapus", { type: "success" });
              loadTours();
            } catch (err) {
              showToast("Gagal menghapus data", { type: "error" });
            }
          }
        });
      });
    </script>
  </body>
</html>
