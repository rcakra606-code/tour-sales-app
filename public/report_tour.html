<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laporan Tour | Travel Dashboard</title>
  <link rel="stylesheet" href="./css/style.css" />
  <script defer src="./js/ui.js"></script>
</head>

<body class="light-mode">
  <!-- ===================================================== -->
  <!-- ğŸ§­ SIDEBAR -->
  <!-- ===================================================== -->
  <aside id="sidebar" class="sidebar expanded">
    <div class="sidebar-header">
      <h2>Travel Dashboard</h2>
      <button id="toggleSidebar">â˜°</button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="dashboard.html">ğŸ  Dashboard</a></li>
      <li><a href="report_sales.html">ğŸ’¹ Laporan Sales</a></li>
      <li class="active"><a href="report_tour.html">âœˆï¸ Laporan Tour</a></li>
      <li><a href="report_document.html">ğŸ“‘ Laporan Dokumen</a></li>
      <li><a href="executive-dashboard.html">ğŸ“Š Executive Dashboard</a></li>
      <li><a href="user-management.html">ğŸ‘¥ User Management</a></li>
      <li><a href="region_management.html">ğŸŒ Region Management</a></li>
      <li><a href="profile.html">ğŸ‘¤ Profil</a></li>
      <li><a href="login.html" id="logoutBtn">ğŸšª Logout</a></li>
    </ul>
    <div class="theme-toggle">
      <span>ğŸŒ</span>
      <label class="switch">
        <input type="checkbox" id="themeSwitch" />
        <span class="slider round"></span>
      </label>
      <span>ğŸŒ™</span>
    </div>
  </aside>

  <!-- ===================================================== -->
  <!-- âœˆï¸ MAIN CONTENT -->
  <!-- ===================================================== -->
  <main id="main-content">
    <header>
      <h1>âœˆï¸ Laporan Tour</h1>
      <p>Kelola dan tinjau data tour termasuk region, pax, sales, dan profit.</p>
    </header>

    <!-- ========================== -->
    <!-- ğŸ§¾ FILTER SECTION -->
    <!-- ========================== -->
    <section class="filters">
      <input type="text" id="searchInput" placeholder="ğŸ” Cari berdasarkan kode booking / nama tamu..." />
      <select id="filterRegion">
        <option value="">ğŸŒ Semua Region</option>
      </select>
      <button id="filterBtn">Terapkan Filter</button>
      <div class="export-buttons">
        <button id="exportExcel">ğŸ“¤ Export Excel</button>
        <button id="exportCSV">ğŸ“„ Export CSV</button>
      </div>
    </section>

    <!-- ========================== -->
    <!-- ğŸ“ FORM INPUT TOUR -->
    <!-- ========================== -->
    <section class="form-section">
      <form id="tourForm">
        <input type="hidden" id="tourId" />

        <div class="form-grid">
          <div>
            <label>Tanggal Registrasi</label>
            <input type="date" id="registrationDate" required />
          </div>
          <div>
            <label>Nama Lead Passenger</label>
            <input type="text" id="leadPassenger" required />
          </div>
          <div>
            <label>Nama Semua Penumpang</label>
            <textarea id="allPassengers" rows="2"></textarea>
          </div>
          <div>
            <label>Tour Code</label>
            <input type="text" id="tourCode" />
          </div>
          <div>
            <label>Region</label>
            <select id="region"></select>
          </div>
          <div>
            <label>Tanggal Keberangkatan</label>
            <input type="date" id="departureDate" />
          </div>
          <div>
            <label>Kode Booking</label>
            <input type="text" id="bookingCode" />
          </div>
          <div>
            <label>Harga Tour (Rp)</label>
            <input type="number" id="tourPrice" step="0.01" />
          </div>
          <div>
            <label>Diskon / Remarks</label>
            <input type="text" id="discountRemarks" />
          </div>
          <div>
            <label>Bukti Pembayaran</label>
            <input type="text" id="paymentProof" />
          </div>
          <div>
            <label>Tanggal Terima Dokumen</label>
            <input type="date" id="documentReceived" />
          </div>
          <div>
            <label>Proses Visa Mulai</label>
            <input type="date" id="visaProcessStart" />
          </div>
          <div>
            <label>Proses Visa Selesai</label>
            <input type="date" id="visaProcessEnd" />
          </div>
          <div>
            <label>Keterangan Dokumen</label>
            <input type="text" id="documentRemarks" />
          </div>
          <div>
            <label>Nama Staff</label>
            <input type="text" id="staff" />
          </div>
          <div>
            <label>Sales Amount (Rp)</label>
            <input type="number" id="salesAmount" step="0.01" />
          </div>
          <div>
            <label>Profit (Rp)</label>
            <input type="number" id="profitAmount" step="0.01" />
          </div>
          <div>
            <label>Status Keberangkatan</label>
            <select id="departureStatus">
              <option value="PENDING">PENDING</option>
              <option value="CONFIRMED">CONFIRMED</option>
              <option value="CANCELLED">CANCELLED</option>
            </select>
          </div>
        </div>

        <button type="submit" id="saveTour">ğŸ’¾ Simpan Tour</button>
        <button type="button" id="resetTour" class="secondary">ğŸ”„ Reset</button>
        <p id="formMsg" class="message"></p>
      </form>
    </section>

    <!-- ========================== -->
    <!-- ğŸ“‹ TABEL DATA TOUR -->
    <!-- ========================== -->
    <section class="table-section">
      <h3>Daftar Data Tour</h3>
      <table id="tourTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Lead Passenger</th>
            <th>Tour Code</th>
            <th>Region</th>
            <th>Tgl Berangkat</th>
            <th>Sales</th>
            <th>Profit</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- ===================================================== -->
  <!-- ğŸ“œ SCRIPT -->
  <!-- ===================================================== -->
  <script>
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");
    if (!token) window.location.href = "login.html";
    const headers = { "Authorization": "Bearer " + token, "Content-Type": "application/json" };

    const tourForm = document.getElementById("tourForm");
    const msg = document.getElementById("formMsg");
    const tableBody = document.querySelector("#tourTable tbody");
    const regionSelect = document.getElementById("region");

    // =============================
    // ğŸ”„ LOAD REGIONS
    // =============================
    async function loadRegions() {
      const res = await fetch("/api/regions", { headers });
      if (!res.ok) return;
      const data = await res.json();
      regionSelect.innerHTML = data.map(r => `<option value="${r.name}">${r.name}</option>`).join("");
      document.getElementById("filterRegion").innerHTML =
        '<option value="">ğŸŒ Semua Region</option>' +
        data.map(r => `<option value="${r.name}">${r.name}</option>`).join("");
    }

    // =============================
    // ğŸ§¾ LOAD TOUR DATA
    // =============================
    async function loadTours() {
      const res = await fetch("/api/tours", { headers });
      const data = await res.json();
      tableBody.innerHTML = data.map(t => `
        <tr>
          <td>${t.id}</td>
          <td>${t.lead_passenger}</td>
          <td>${t.tour_code}</td>
          <td>${t.region}</td>
          <td>${t.departure_date ? new Date(t.departure_date).toLocaleDateString("id-ID") : "-"}</td>
          <td>${t.sales_amount?.toLocaleString("id-ID") || 0}</td>
          <td>${t.profit_amount?.toLocaleString("id-ID") || 0}</td>
          <td>${t.departure_status}</td>
          <td>
            <button onclick="editTour(${t.id})">âœï¸</button>
            <button onclick="deleteTour(${t.id})" class="danger">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `).join("");
    }

    // =============================
    // ğŸ’¾ SAVE / UPDATE TOUR
    // =============================
    tourForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "";
      const id = document.getElementById("tourId").value;
      const payload = {
        registrationDate: registrationDate.value,
        leadPassenger: leadPassenger.value,
        allPassengers: allPassengers.value,
        tourCode: tourCode.value,
        region: region.value,
        departureDate: departureDate.value,
        bookingCode: bookingCode.value,
        tourPrice: parseFloat(tourPrice.value) || 0,
        discountRemarks: discountRemarks.value,
        paymentProof: paymentProof.value,
        documentReceived: documentReceived.value,
        visaProcessStart: visaProcessStart.value,
        visaProcessEnd: visaProcessEnd.value,
        documentRemarks: documentRemarks.value,
        staff: staff.value,
        salesAmount: parseFloat(salesAmount.value) || 0,
        profitAmount: parseFloat(profitAmount.value) || 0,
        departureStatus: departureStatus.value,
      };

      const method = id ? "PUT" : "POST";
      const url = id ? `/api/tours/${id}` : "/api/tours";

      try {
        const res = await fetch(url, { method, headers, body: JSON.stringify(payload) });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Gagal menyimpan data tour.");

        msg.textContent = data.message || "Tour berhasil disimpan.";
        msg.style.color = "#28a745";
        tourForm.reset();
        document.getElementById("tourId").value = "";
        loadTours();
      } catch (err) {
        msg.textContent = "Gagal menyimpan data tour.";
        msg.style.color = "#e74c3c";
      }
    });

    // =============================
    // âœï¸ EDIT TOUR
    // =============================
    window.editTour = async function (id) {
      const res = await fetch(`/api/tours`, { headers });
      const data = await res.json();
      const tour = data.find(t => t.id === id);
      if (!tour) return;

      for (const key in tour) {
        const el = document.getElementById(key);
        if (el) el.value = tour[key] || "";
      }
      document.getElementById("tourId").value = id;
    };

    // =============================
    // ğŸ—‘ï¸ DELETE TOUR
    // =============================
    window.deleteTour = async function (id) {
      if (!confirm("Yakin ingin menghapus data tour ini?")) return;
      const res = await fetch(`/api/tours/${id}`, { method: "DELETE", headers });
      if (res.ok) loadTours();
    };

    document.getElementById("resetTour").addEventListener("click", () => {
      tourForm.reset();
      document.getElementById("tourId").value = "";
      msg.textContent = "";
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });

    loadRegions();
    loadTours();
  </script>
</body>
</html>