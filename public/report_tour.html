<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laporan Tour | Travel Dashboard</title>
  <link rel="stylesheet" href="./css/style.css" />
  <script defer src="./js/ui.js"></script>
</head>
<body class="light-mode">
  <!-- ===================================================== -->
  <!-- 🧭 SIDEBAR -->
  <!-- ===================================================== -->
  <aside id="sidebar" class="sidebar expanded">
    <div class="sidebar-header">
      <h2>Travel Dashboard</h2>
      <button id="toggleSidebar">☰</button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="dashboard.html">🏠 Dashboard</a></li>
      <li><a href="report_sales.html">💹 Laporan Sales</a></li>
      <li class="active"><a href="report_tour.html">✈️ Laporan Tour</a></li>
      <li><a href="report_document.html">📑 Laporan Dokumen</a></li>
      <li><a href="user-management.html">👥 User Management</a></li>
      <li><a href="profile.html">👤 Profil</a></li>
      <li><a href="login.html" id="logoutBtn">🚪 Logout</a></li>
    </ul>
    <div class="theme-toggle">
      <span>🌞</span>
      <label class="switch">
        <input type="checkbox" id="themeSwitch" />
        <span class="slider round"></span>
      </label>
      <span>🌙</span>
    </div>
  </aside>

  <!-- ===================================================== -->
  <!-- 📊 MAIN CONTENT -->
  <!-- ===================================================== -->
  <main id="main-content">
    <header>
      <h1>✈️ Laporan Tour</h1>
      <p>Data rekap tour berdasarkan tanggal keberangkatan, region, dan staff</p>
    </header>

    <!-- 🔍 FILTERS -->
    <section class="filters">
      <input type="text" id="regionFilter" placeholder="Cari region..." />
      <input type="month" id="monthFilter" />
      <input type="text" id="staffFilter" placeholder="Nama staff..." />
      <button id="filterBtn">Terapkan Filter</button>
      <div class="export-buttons">
        <button id="exportExcel">📘 Export Excel</button>
        <button id="exportCSV">📄 Export CSV</button>
      </div>
    </section>

    <!-- 📋 TABLE -->
    <section class="table-section">
      <table id="tourTable">
        <thead>
          <tr>
            <th>No</th>
            <th>Lead Passenger</th>
            <th>Semua Penumpang</th>
            <th>Tour Code</th>
            <th>Region</th>
            <th>Tanggal Berangkat</th>
            <th>Booking Code</th>
            <th>Harga Tour</th>
            <th>Staff</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tourTableBody">
          <tr><td colspan="10" class="center">Memuat data...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <!-- ===================================================== -->
  <!-- 📜 SCRIPT -->
  <!-- ===================================================== -->
  <script>
    const token = localStorage.getItem("token");
    const headers = { "Authorization": `Bearer ${token}` };

    async function fetchTourData(region = "", month = "", staff = "") {
      try {
        const response = await fetch("/api/report/tour", { headers });
        const data = await response.json();

        let filtered = data;
        if (region) {
          filtered = filtered.filter((r) =>
            r.region?.toLowerCase().includes(region.toLowerCase())
          );
        }
        if (month) {
          const [year, mon] = month.split("-");
          filtered = filtered.filter((r) => {
            const date = new Date(r.departure_date);
            return (
              date.getFullYear() === parseInt(year) &&
              date.getMonth() + 1 === parseInt(mon)
            );
          });
        }
        if (staff) {
          filtered = filtered.filter((r) =>
            r.staff?.toLowerCase().includes(staff.toLowerCase())
          );
        }

        const tbody = document.getElementById("tourTableBody");
        tbody.innerHTML = "";

        if (filtered.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="10" class="center">Tidak ada data ditemukan.</td></tr>';
          return;
        }

        filtered.forEach((row, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${row.lead_passenger || "-"}</td>
            <td>${row.all_passengers || "-"}</td>
            <td>${row.tour_code || "-"}</td>
            <td>${row.region || "-"}</td>
            <td>${new Date(row.departure_date).toLocaleDateString("id-ID")}</td>
            <td>${row.booking_code || "-"}</td>
            <td>Rp ${Number(row.tour_price || 0).toLocaleString("id-ID")}</td>
            <td>${row.staff || "-"}</td>
            <td>${row.departure_status || "PENDING"}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("❌ Error memuat data tour:", err);
      }
    }

    document.getElementById("filterBtn").addEventListener("click", () => {
      const region = document.getElementById("regionFilter").value;
      const month = document.getElementById("monthFilter").value;
      const staff = document.getElementById("staffFilter").value;
      fetchTourData(region, month, staff);
    });

    document.getElementById("exportExcel").addEventListener("click", () => {
      window.open("/api/report/tour/export?format=xlsx", "_blank");
    });

    document.getElementById("exportCSV").addEventListener("click", () => {
      window.open("/api/report/tour/export?format=csv", "_blank");
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });

    // Jalankan saat halaman dibuka
    fetchTourData();
  </script>
</body>
</html>