# ==========================================================
# 🚀 Render Deployment Config — Travel Dashboard Enterprise v3.4.2
# ==========================================================
# ✅ Auto-init database via scripts/init-db.js
# ✅ PostgreSQL (Neon) connection ready
# ✅ Secure environment with JWT_SECRET
# ✅ Compatible with auto health check
# ✅ Cron job & disk mount included
# ==========================================================

services:
  - type: web
    name: travel-dashboard
    env: node
    region: singapore
    plan: free

    # ============================================
    # 🔧 Build & Start Commands
    # ============================================
    buildCommand: |
      echo "📦 Installing dependencies..."
      npm install
    startCommand: |
      echo "⚙️ Menjalankan inisialisasi database..."
      node scripts/init-db.js || echo "⚠️ Init DB gagal, lanjutkan startup..."
      echo "🚀 Menjalankan server..."
      node server.js

    # ============================================
    # 🌍 Environment Variables
    # ============================================
    envVars:
      - key: NODE_ENV
        value: production

      - key: PORT
        value: 3000

      # 🔑 Database Neon PostgreSQL connection
      - key: DATABASE_URL
        value: postgresql://neondb_owner:password@ep-yourdb-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require

      # 🔒 JWT Secret for token encryption
      - key: JWT_SECRET
        generateValue: true

      # 🔐 Optional: Default admin password
      - key: INIT_ADMIN_PASSWORD
        value: admin123

      # 🕒 Cron-like backup setting (optional)
      - key: CRON_BACKUP_SCHEDULE
        value: "0 3 * * *"

    # ============================================
    # 💾 Persistent Storage
    # ============================================
    disk:
      name: data-storage
      mountPath: /opt/render/project/src/data
      sizeGB: 1

    # ============================================
    # ❤️ Health Check
    # ============================================
    healthCheckPath: /api/health

    # ============================================
    # ⚙️ Deployment Behavior
    # ============================================
    autoDeploy: true
